// For direct comparison of elastix implementation of cubic B-spline FFD algorithm
// of Rueckert et al. (1999) to IRTK 'nreg', MIRTK 'register', and NiftyReg F3D.
// Options chosen to reflect as close as possible these other implementations.
//
// Main application of interest: Inter-subject brain MR image registration
// using T1-weighted images for adults and T2-weighted images for neonates.
// For [M]IRTK and NiftyReg, NMI with cubic B-spline Parzen window estimator
// is commonly used for this type of registration task.
//
// Version: elastix 4.8

(ShowExactMetricValue "false")
(UseFastAndLowMemoryVersion "true")
(UseDirectionCosines "true")

(WriteResultImage "true")
(ResultImagePixelType "short")
(ResultImageFormat "nii.gz")
(CompressResultImage "true")

(FixedInternalImagePixelType "float")
(MovingInternalImagePixelType "float")
(FixedImageDimension 3)
(MovingImageDimension 3)
(DefaultPixelValue 0)

(ErodeFixedMask "true")
(ErodeMovingMask "true")

(NumberOfResolutions 4)
(ImagePyramidSchedule 8 8 8 4 4 4 2 2 2 1 1 1)
(Registration "MultiMetricMultiResolutionRegistration")
(FixedImagePyramid "FixedRecursiveImagePyramid")
(MovingImagePyramid "MovingRecursiveImagePyramid")
(Interpolator "BSplineInterpolator")
(ResampleInterpolator "FinalBSplineInterpolator")
(BSplineInterpolationOrder 1)
(FinalBSplineInterpolationOrder 1)
(Resampler "DefaultResampler")

(FinalGridSpacingInPhysicalUnits 2.5)
(GridSpacingSchedule 8.0 4.0 2.0 1.0)
(Transform "BSplineTransform")
(BSplineTransformSplineOrder 3)
(UseCyclicTransform "false")
(HowToCombineTransforms "Add") // IRTK model, see Rueckert et al. (1999)

(Metric "NormalizedMutualInformation" "TransformBendingEnergyPenalty")
(NumberOfSamplesForSelfHessian 100000)  // TransformBendingEnergyPenalty
(FixedKernelBSplineOrder 3)
(MovingKernelBSplineOrder 3)
(NumberOfHistogramBins 64)
(NumberOfFixedHistogramBins 64)
(NumberOfMovingHistogramBins 64)
(FixedLimitRangeRatio 0.01)
(MovingLimitRangeRatio 0.01)
(UseRelativeWeights "false")
(Metric0Weight 1)
(Metric1Weight 0.01)

//(Optimizer "ConjugateGradientFRPR")
(Optimizer "ConjugateGradient")
(ConjugateGradientType "PolakRibiere")
(MaximumNumberOfIterations 100)
(MaximumNumberOfLineSearchIterations 20)
(GenerateLineSearchIterations "false")
(LineSearchGradientTolerance 0.9)
(LineSearchValueTolerance 0.0001)
(GradientMagnitudeTolerance 1e-06)
(ValueTolerance 1e-05)
(StopIfWolfeNotSatisfied "true")
(StepLength 4.0 2.0 1.0 0.5)

(ImageSampler "Full")
(NewSamplesEveryIteration "false")
(CheckNumberOfSamples "false")
