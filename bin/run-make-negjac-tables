#!/bin/bash

print_help()
{
  error "usage: $(basename $BASH_SOURCE) <dataset> <regid> [<cfgid>...]"
}

# load settings and auxiliary functions
. "$(dirname "$BASH_SOURCE")/../etc/settings.sh" || exit 1
[ -n "$topdir" ] || error "etc/settings.sh: topdir not set"
[ -n "$etcdir" ] || error "etc/settings.sh: etcdir not set"
[ -n "$vardir" ] || error "etc/settings.sh: vardir not set"
[ -n "$csvdir" ] || error "etc/settings.sh: csvdir not set"

# change to top-level directory
run cd "$topdir"

# evaluation dataset
dataset="$1"; shift
[ -n "$dataset" ] || print_help
. "$etcdir/dataset-$dataset.sh"
[ ${#chns[@]}   -gt 0 ] || error "$etcdir/dataset-$dataset.sh: chns not set"
[ ${#imgids[@]} -gt 0 ] || error "$etcdir/dataset-$dataset.sh: imgids not set"
[ ${#tgtids[@]} -gt 0 ] || tgtids=("${imgids[@]}")
[ ${#srcids[@]} -gt 0 ] || srcids=("${imgids[@]}")

# registration method
regid="$1"; shift
[ -n "$regid" ] || print_help

# parameter set
cfgids=("$@")
[ ${#cfgids} -gt 0 ] || cfgids=($(get_cfgids "$regid"))
[ ${#cfgids} -gt 0 ] || error "etc/settings.sh: get_cfgids is empty for $regid"

# write tables
chn="${chns[0]}"
[ -n "$chn" ] || error "Invalid first chns entry"

for cfgid in "${cfgids[@]}"; do
  echo "Write no. of neg. Jacobians table for configuration $cfgid"

  dofdir="$vardir/$dataset/$regid/$cfgid/dof"
  imgdir="$vardir/$dataset/$regid/$cfgid/out/${chns[0]}"
  outdir="$csvdir/$dataset/$regid/$cfgid"

  makedir "$outdir"

  for tgtid in "${tgtids[@]}"; do
    outcsv="$outdir/$tgtid-negjac.csv"
    [ $force = true ] || [ ! -f "$outcsv" ] || continue
    run "$libdir/print-negjac-table" "$dataset" "$regid" "$cfgid" "$tgtid" > "$outcsv"
  done
done
